/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e,dcSessionStorage as t}from"../../../common/local-storage.js";import{dcTabStorage as n}from"../tab-storage.js";import{util as a}from"../content-util.js";import{signInUtil as r}from"./signInUtils.js";import{privateApi as i}from"../content-privateApi.js";import{OptionPageActions as s}from"../../../common/constant.js";await e.init(),await t.init();let o=!1;!function(){let c,l,d,m,g,p,u,f,h,w,I,b,y,_,v,S,L,E,P;const C=chrome.runtime.getURL("viewer.html"),D=chrome.runtime.getURL("signInHandler.html"),R="file:",U=["https:","http:",R],x=e=>{if(!e)return!1;try{const t=new URL(e),n=t.protocol;let a=-1!==U.indexOf(n);return a=n===R?t.pathname.toLowerCase().endsWith(".pdf"):a,a}catch(e){return!1}};function T(e){const t=n.getItem("search");return new URLSearchParams(t).get(e)}function k(e,t){return _?(v=v||1,e.tabId=v,e.mimeHandled=!0,chrome.runtime.sendMessage(e,t)):chrome.runtime.sendMessage(e,t)}function B(e,t){return new URLSearchParams(e).get(t)||""}function F(){if(m=B(document.location.search,"pdfurl"),!x(m))return void(g=!1);!function(){const e=new URLSearchParams(document.location.search),n=t.getItem("rtParams");if(n){const a=n.split(",").map((t=>e.has(t)?`&${t}=${e.get(t)}`:null)).join("")||"";t.setItem("payPalUrl",a),t.removeItem("rtParams")}}();const e=n.getItem("search");(!e||B(e,"pdfurl")!==m||e.length<document.location.search)&&n.setItem("search",document.location.search),d=B(document.location.search,"pdffilename")||B(e,"pdffilename")||X(m),document.title=d;const a="/"+m+location.hash;history.replaceState({},d,a)}function M(t=!1){if(_)try{t||k({main_op:"viewer-type",viewer:"mime-native"}),setTimeout((()=>{i.reloadWithNativeViewer({contentLength:parseInt(c)||0})}),100)}catch(e){A("DCBrowserExt:Viewer:FallbackToNative:Failed")}else try{setTimeout((()=>{chrome.tabs.getCurrent((function(t){e.setItem(`reloadurl-${t.id}`,m),window.location.href=m}))}),500)}catch(e){A("DCBrowserExt:Viewer:FallbackToNative:Failed")}}const V=t=>{try{const n=new URL(e.getItem("cdnUrl")),a=[/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/];return t===n.origin&&!!a.find((e=>e.test(t)))}catch(e){return!1}};function A(e){const t={main_op:"analytics"};t.analytics=[[e]],k(t)}function O(){let e,t=C;return _?(e="?mimePdfUrl="+encodeURIComponent(m),t=D):(e=n.getItem("search"),e||(e="?pdfurl="+m)),new URL(t+e)}const N=["AdobeID","openid","DCAPI","sign_user_read","sign_user_write","sign_user_login","sign_library_read","sign_library_write","agreement_send","agreement_read","agreement_write","ab.manage","additional_info.account_type","sao.ACOM_ESIGN_TRIAL","widget_read","widget_write","workflow_read","workflow_write"];function H(t={}){const r=e.getItem("imsURL"),i=e.getItem("viewerImsClientId"),s=e.getItem("imsContextId"),o=new URL(r+"/ims/authorize/v1?"),c=O(),l=a.uuid(),d={csrf:l};t.sign_up?(o.searchParams.append("idp_flow","create_account"),c.hash=c.hash+"signUp=true"):c.hash=c.hash+"signIn=true",n.setItem("csrf",l),o.searchParams.append("response_type","token"),o.searchParams.append("client_id",i),o.searchParams.append("redirect_uri",c),o.searchParams.append("scope",N.join(",")),o.searchParams.append("dctx_id",s),o.searchParams.append("locale",e.getItem("locale")),o.searchParams.append("state",JSON.stringify(d)),chrome.tabs.update({url:o.href,active:!0})}function z(){let e;e=_?O().href:window.location.href,r.sign_out(e)}function $(e){let t=new URL(D);return t.searchParams.append("socialSignIn","true"),t.searchParams.append("mimePdfUrl",encodeURIComponent(m)),n.setItem("idp_token",e),t.href}const W={isSharePointURL:!1,isSharePointFeatureEnabled:!1,isFrictionlessEnabled:!0,featureFlags:[],isFillAndSignRegisteryEnabled:!1};class q{constructor(e){this.iframeElement=void 0,this.parentDiv=e}createIframe=t=>{const n=window.document,a=(e.getItem("cdnUrl"),n.createElement("iframe"));a.setAttribute("src",t),a.setAttribute("id","dc-view-frame"),a.setAttribute("allowfullscreen","allowfullscreen"),a.setAttribute("allow","clipboard-read; clipboard-write;"),a.style.width="100vw",a.style.height="100vh",a.style.border="none",a.style.overflow="hidden",this.parentDiv.appendChild(a),this.iframeElement=n.getElementById("dc-view-frame")};_sendMessage=(e,t)=>{this.iframeElement&&V(t)&&function(e){let t=Date.now();return new Promise((function n(a,r){p&&(g||_)?a(g||_):e&&Date.now()-t>=e?r(new Error("timeout")):setTimeout(n.bind(this,a,r),30)}))}(1e6).then((n=>n&&this.iframeElement.contentWindow.postMessage(e,t)))};sendStartupConfigs=(e,n)=>{this._sendMessage({type:"nativeConfigs",nativeConfigs:W,extUrl:encodeURI(e),returnParamsUrl:t.getItem("payPalUrl"),isInstallTypeUpsell:o},n)};sendFileMetaData=(e,t,n,a,r,i,s,o)=>{this._sendMessage({fileUrl:r,fileName:i,fileSize:n,acceptRanges:a,handShakeTime:t,type:e,isFrictionlessEnabled:W.isFrictionlessEnabled,isReloadOrBackForward:o,isMimeHandled:_},s)};sendSubmitFormResponse=(e,t)=>{this._sendMessage({type:"submitForm",response:e},t)};sendRecentUrl=(e,t,n,a=!1)=>{this._sendMessage({type:"RecentUrls",permission:e,showOverlay:a,recentUrls:t},n)};sendProgress=(e,t,n,a)=>{this._sendMessage({total:t,loaded:n,type:e},a)};sendInitialBuffer=(e,t,n,a,r)=>{this._sendMessage({type:e,downLoadstartTime:t,downLoadEndTime:n,buffer:a},r)};sendBufferRanges=(e,t,n,a)=>{this._sendMessage({type:e,range:t,buffer:n},a)};preview=(e,t,n,a,r,i,s)=>{this._sendMessage({fileSize:n,type:e,fileBuffer:t,fileName:a,downLoadstartTime:r,downLoadEndTime:i},s)};openInAcrobatResponse=(e,t,n)=>{this._sendMessage({type:e,res:t},n)};postLog=(e,t,n,a,r)=>{this._sendMessage({type:e,reqId:t,message:n,error:a},r)}}function G(t,n){try{I=void 0!==I?I:"false"!==e.getItem("logAnalytics")&&"false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),I&&(h&&l?h.postLog("log",w,t,n,l.origin):setTimeout((()=>{h&&l&&h.postLog("log",w,t,n,l.origin)}),500))}catch(e){}}function j(){let e;return e=_?m:window.location.href,e}function J(t,n,a,r,i){i&&t.forEach((e=>{a.has(e)&&n.searchParams.append(e,a.get(e))})),r&&t.forEach((t=>{""!==e.getItem(t)&&n.searchParams.append(t,e.getItem(t))}))}const K=()=>{if(v){const t=e.getItem("loadedTabsInfo");let n;t&&t.tabsInfo?(n=t.tabsInfo,n.includes(v)||n.push(v)):n=[v],e.setItem("loadedTabsInfo",{tabsInfo:n})}},Y=()=>{try{!function(){const e=j();if(e.indexOf("access_token")>-1&&n.getItem("signInSource")){const t=n.getItem("csrf"),a=r.parseCSRF(new URL(e));n.removeItem("csrf"),(!t||!a||a!==t)&&(A("DCBrowserExt:Viewer:User:Error:NonMatchingCsrfToken:FailedToLogin"),z())}}(),function(){try{let e=j();e&&e.indexOf("#")>-1&&(r.signInAnalyticsLogging(e),e=e.split("#")[0],_?m=e:window.location.href=e)}catch(e){}}();const t=window.document.getElementById("Adobe-dc-view");_||(c=T("clen")||-1),h=new q(t);const a=(()=>{try{const t=e.getItem("cdnUrl"),a=new URL(t);if(!V(a.origin))return G("Invalid CDN URL detected","Invalid Origin"),void M();l||(l=a);let r=e.getItem("viewer-locale");r||(r=e.getItem("locale"));const i="false"!==e.getItem("logAnalytics"),s="false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),o="true"===e.getItem("betaOptOut");a.searchParams.append("locale",r),a.searchParams.append("logAnalytics",i&&s),a.searchParams.append("callingApp",chrome.runtime.id),a.searchParams.append("betaOptOut",o),a.searchParams.append("enableCaretMode",E);const c=e.getItem("installType")||"update",d=e.getItem("installSource");a.searchParams.append("version",`${chrome.runtime.getManifest().version}:${c}`),a.searchParams.append("installSource",d),"false"===e.getItem("staticFteCoachmarkShown")&&a.searchParams.append("showFTECoachmark","true"),"true"!==T("googlePrint")&&!0!==S||"false"===n.getItem("googleAppsPrint")||a.searchParams.append("googleAppsPrint","true");const g=["dropin!","provider!","app!"],p=["analytics","logToConsole","enableLogging","frictionless","sessionId","linearization"],u=["isReadAloudEnable","isModernViewerEnable","isDeskTop","isAcrobat","theme","defaultOwnerShipExperiment"];let f;e.getItem("env"),f=_?new URLSearchParams(new URL(m).search):new URLSearchParams(window.location.search),J(p,a,f,!1,!0),J(u,a,f,!0,!1);let h=a.href;return g.forEach((e=>{f.forEach(((t,n)=>{n.startsWith(e)&&(h=h+"&"+n+"="+t)}))})),h}catch(e){A("DCBrowserExt:Viewer:Iframe:Creation:Failed"),M()}})();h.createIframe(a),window.addEventListener("message",(t=>{!t.data||!V(t.origin)||u||"hsready"!==t.data.type&&"ready"!==t.data.type||(u=!0,f=(new Date).getTime(),w=t.data.requestId,"on"===t.data.killSwitch?(A("DCBrowserExt:Viewer:KillSwitch:Turned:On"),e.setItem("pdfViewer","false"),i.setViewerState("disabled"),e.setItem("killSwitch","on"),_?M(!0):setTimeout((()=>{window.location.href=m}),200)):e.getItem("killSwitch")&&(A("DCBrowserExt:Viewer:KillSwitch:Turned:Off"),e.removeItem("killSwitch")))}))}catch(e){G("Error create Iframe",e)}};function X(e){if(d)return d;let t=e;try{const n=e.split("?")[0].split("/").filter((e=>e.length>0)),a=n.length>0?n[n.length-1]:"untitled";t=a;const r=a.length-4;(a.length<4||a.toLowerCase().indexOf(".pdf")!==r)&&(t+=".pdf")}catch(e){G("Error in getFileNameFromURL",e)}return t}function Z(e,t){return new Promise(((n,a)=>{const r=(new Date).getTime(),i=new XMLHttpRequest;i.open("GET",e.url),i.responseType="arraybuffer",i.setRequestHeader("Range",`bytes=${t.start}-${t.end}`),i.onload=()=>{if(4===i.readyState&&206===i.status)n({buffer:i.response,startTime:r,endTime:(new Date).getTime()});else if(200===i.status){const e={status:i.status,statusText:i.statusText,fileSize:c,rangeBufferSize:i.response.byteLength,range:t};a({message:"Unexpected response to get file buffer range",error:e})}else{const e={status:i.status,statusText:i.statusText,fileSize:c,range:t};a({message:"Invalid response to get file buffer ranger",error:e})}},i.onerror=e=>{a({message:"Error to get file buffer range",error:e})},i.ontimeout=e=>{a({message:"Timeout to get file buffer range due to timeout",error:e})},i.send()}))}function Q(e,t){"PDF"===function(e){if(e)try{let t=new URL(e).pathname;return t.substr(t.lastIndexOf(".")+1).toUpperCase()}catch(e){return""}return""}(e)&&(g=!0);const n=new XMLHttpRequest;n.open("GET",e),n.responseType="arraybuffer",n.onreadystatechange=function(){4===n.readyState&&(200!==n.status&&0!=n.status||t({buffer:n.response,mimeType:n.getResponseHeader("content-type")}))},n.send(null)}function ee(e,t,n){return new Promise(((a,r)=>{const i=m;if(i.startsWith("file://"))return void Q(i,a);const s=new XMLHttpRequest;var o;s.open("GET",i),s.responseType="arraybuffer",t&&s.setRequestHeader("If-Range","randomrange"),s.onreadystatechange=(o=s,function(e){if(this.readyState==this.HEADERS_RECEIVED){if(!function(e,t){const n=e.getResponseHeader("content-type"),a=e.getResponseHeader("content-disposition");if(n){const e=n.toLowerCase().split(";",1)[0].trim();if(a&&/^\s*attachment[;]?/i.test(a))return!1;if("application/pdf"===e)return!0;if("application/octet-stream"===e&&a&&/\.pdf(["']|$)/i.test(a))return!0}return!1}(o))return G("Fall back to native - not pdf from headers"),M();g=!0}}),s.onprogress=function(e,t){return function(n){n.lengthComputable&&(c=n.total,e.sendProgress("progress",n.total,n.loaded,t))}}(e,n),s.onload=()=>{if(s.status>=200&&s.status<400)a({buffer:s.response,mimeType:s.getResponseHeader("content-type"),downLoadEndTime:(new Date).getTime()});else{const e={status:s.status,statusText:s.statusText};r({message:"Invalid response fetching content",error:e})}},s.onerror=e=>{r({message:"Error to download file contents",error:e})},s.ontimeout=e=>{r({message:"Timeout to download file contents",error:e})},s.send()}))}function te(t,n,a=!1){if(_){const r=e.getItem("recentFilesData");if(r&&r.isSyncedWithHistory){const e=r.recentFilesPath?[...r.recentFilesPath]:[],i=[];for(let t=e.length-1;t>=0;t--)i.push({...e[t],chromeHistory:!0,url:`chrome-extension://${chrome.runtime.id}/viewer.html?pdfurl=${e[t].url}`,mimeUrl:e[t].url});t.sendRecentUrl(!0,i,n,a)}}else chrome.history.search({text:chrome.runtime.getURL("viewer.html"),startTime:0,maxResults:1e3},(e=>{const r=e.filter((e=>e.url.startsWith(chrome.runtime.getURL("viewer.html")))),i=[];for(let e=0;e<r.length;++e){const{url:t,title:n}=r[e],{lastVisitTime:a}=r[e];i.push({filename:n,url:t,lastVisited:a,chromeHistory:!0})}t.sendRecentUrl(!0,i,n,a)}))}function ne(i,o){switch(o.data.main_op){case"open_in_acrobat":case"fillsign":!async function(t,n){const r={main_op:"open_in_acrobat"};if("fillsign"===n.data.main_op&&(r.paramName="FillnSign"),r.url=n.data.url,r.click_context="pdfviewer",r.timeStamp=Date.now(),n.data.fileBuffer){const e=new Blob([n.data.fileBuffer],{type:"application/pdf"});r.dataURL=URL.createObjectURL(e)}if(L=function(e){"fillsign"===n.data.main_op?t.openInAcrobatResponse("FILLSIGN_IN_DESKTOP_APP",e,n.origin):t.openInAcrobatResponse("OPEN_IN_DESKTOP_APP",e,n.origin),G(`Open In Acrobat - (${n.data.main_op}) response- ${e}`)},e.getItem("isSharepointFeatureEnabled"))if(W.isSharePointURL)r.workflow_name="SharePoint",r.isSharePointURL=!0,k(r,L);else{const e=await a.checkForSharePointURL(r.url);r.isSharePointURL=e,e&&(r.workflow_name="SharePoint"),k(r,L)}else k(r,L)}(i,o);break;case"complete_conversion":A("DCBrowserExt:Viewer:Verbs:Conversion:Redirection"),function(e){const t={};t.main_op=e.data.main_op,t.conversion_url=decodeURIComponent(e.data.conversion_url),t.timeStamp=Date.now(),k(t)}(o);break;case"updateLocale":A("DCBrowserExt:Viewer:User:Locale:Updated"),e.setItem("viewer-locale",o.data.locale),k({main_op:"localeChange",locale:o.data.locale}),chrome.tabs.reload();break;case"setInitialLocale":let d=!1;e.getItem("viewer-locale")||(d=!0,e.setItem("viewer-locale",o.data.locale),A("DCBrowserExt:Viewer:User:Locale:Initial")),o.data.reloadReq&&d&&chrome.tabs.reload();break;case"error-sign-in":!function(e){const t=a.uuid();n.setItem("csrf",t);const r=new URL(e),i=O();i.hash=i.hash+`state=${t}&signInError=true`,r.searchParams.set("redirect_uri",i),chrome.tabs.update({url:r.href,active:!0})}(o.data.url);break;case"deleteViewerLocale":e.getItem("viewer-locale")&&(e.removeItem("viewer-locale"),chrome.tabs.reload());break;case"signin":A("DCBrowserExt:Viewer:Ims:Sign:In"),n.setItem("signInSource",o.data.source),A(`DCBrowserExt:Viewer:Ims:Sign:In:${o.data.source}`),H();break;case"googleSignIn":A("DCBrowserExt:Viewer:Ims:Sign:In"),A(`DCBrowserExt:Viewer:Ims:Sign:In:${o.data.source}`),n.setItem("signInSource",o.data.source),function(){const t=e.getItem("viewerImsClientIdSocial"),r=e.getItem("imsURL"),i=a.uuid(),s=O();s.hash=s.hash+"signIn=true";const o=new URL(r+"/ims/authorize/v1"),c={ac:a.isEdge()?"adobe.com_acrobatextension_edge_login":"adobe.com_acrobatextension_chrome_login",csrf:i};n.setItem("csrf",i),o.searchParams.append("response_type","token"),o.searchParams.append("idp_flow","social.deep_link.web"),o.searchParams.append("client_id",t),o.searchParams.append("provider_id","google"),o.searchParams.append("redirect_uri",s),o.searchParams.append("scope",N.join(",")),o.searchParams.append("locale",e.getItem("locale")),o.searchParams.append("state",JSON.stringify(c)),o.searchParams.append("xApiClientId",t),o.searchParams.append("xApiClientLocation ","google"),chrome.tabs.update({url:o.href,active:!0})}();break;case"signup":A("DCBrowserExt:Viewer:Ims:Sign:Up"),n.setItem("signUpSource",o.data.source),A(`DCBrowserExt:Viewer:Ims:Sign:Up:${o.data.source}`),H({sign_up:!0});break;case"reload_viewer":chrome.tabs.reload();break;case"upsell_event":!function(e){if(e&&e.url){const n=new URL(decodeURIComponent(e.url));e.returnUrlParams&&t.setItem("rtParams",e.returnUrlParams.toString()),"_blank"===e.target?chrome.tabs.create({url:n.href,active:!0}):chrome.tabs.update({url:n.href,active:!0})}}(o.data);break;case"upsell_remove_urlParams":t.removeItem("rtParams"),t.removeItem("payPalUrl");break;case"fetchLocalRecents":const g=new URL(e.getItem("cdnUrl")).origin;chrome.permissions.contains({permissions:["history"],origins:["https://www.google.com/"]},(e=>{if(o.data.fetchRecents){const t=o.data.showOverlay;e||_?te(h,g,t):(A("DCBrowserExt:Permissions:History:DialogTriggered"),chrome.permissions.request({permissions:["history"],origins:["https://www.google.com/"]},(e=>{e?(A("DCBrowserExt:Permissions:History:Granted"),te(h,g,t)):(A("DCBrowserExt:Permissions:History:Denied"),h.sendRecentUrl(!1,null,g))})))}else e||_?h.sendRecentUrl(!0,null,g):h.sendRecentUrl(!1,null,g)}));break;case"socialSignIn":A("DCBrowserExt:Viewer:Ims:Sign:In"),A(`DCBrowserExt:Viewer:Ims:Sign:In:${o.data.source}`),n.setItem("signInSource",o.data.source),c=o.data.idp_token,_?chrome.tabs.update({url:$(c),active:!0}):r.socialSignIn(c,O());break;case"openRecentFileLink":const p={};p.main_op=o.data.main_op,p.recent_file_url=decodeURIComponent(o.data.recent_file_url),k(p);break;case"userSubscriptionData":if(_){const e={};e.eventType=o.data.main_op,e.userSubscriptionData=o.data.userSubscriptionData,e.data=o.data,e.main_op=o.data.main_op;k(e,(function(e){e&&"showUninstallPopUp"===e.main_op&&h._sendMessage({type:"showUninstallPopUp"},l.origin)}))}break;case"uninstall":_&&k({main_op:"uninstall",defaultUrl:m});break;case"submit_form":fetch(o.data.resource,o.data.options).then((e=>{h.sendSubmitFormResponse(e.ok,o.origin)})).catch((()=>{h.sendSubmitFormResponse(!1,o.origin)}));break;case"ownerShipExperimentShown":e.removeItem("defaultOwnerShipExperiment");break;case"openAcrobatOptions":chrome.runtime.openOptionsPage(),A(`DCBrowserExt:Viewer:ManagePref:clicked:${o.data.source}`);break;case"encryptedWriteFile":document.title.endsWith(o.data.secureString)||(document.title+=o.data.secureString);break;case"saveAsEvent":!async function(e){try{if(A("DCBrowserExt:Viewer:SaveToMyComputer:"+(P?"fileHandlerExist":"fileHandlerNotExist")),!P){const t={suggestedName:`${e.fileName}.pdf`,types:[{description:"PDF file",accept:{"application/pdf":[".pdf"]}}]};P=await window.showSaveFilePicker(t)}const t=await P.createWritable();await t.write(e.fileBuffer),await t.close(),h._sendMessage({type:"saveToLocalResponse"},l.origin)}catch(e){P=null,G("Save As Handler Error",e),h._sendMessage({type:"saveToLocalResponse",error:e},l.origin)}}(o.data);break;case"rememberSaveLocationPreference":!function(t){let n="";t.cloudStorage&&!e.getItem("selectedSaveLocationPreference")?n="PreferenceMigrationSuccess":t.cloudStorage||(n="SaveDialogRememberMe");n&&A(`DCBrowserExt:Viewer:ChangeSaveLocationPreference:${n}`);(!t.cloudStorage||t.cloudStorage&&!e.getItem("selectedSaveLocationPreference"))&&(e.setItem("saveLocation",t.saveLocation),e.setItem("selectedSaveLocationPreference",!0),k({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"saveLocationPreferenceTitle",toggleVal:t.saveLocation}))}(o.data)}var c}function ae(e){try{const t=new TextDecoder("utf-8").decode(e.buffer);let n=!1;-1!=t.indexOf("Linearized 1")?(n=!0,A("DCBrowserExt:Viewer:Linearization:Linearized:Version:1")):-1!=t.indexOf("Linearized")?A("DCBrowserExt:Viewer:Linearization:Linearized:Version:Other"):A("DCBrowserExt:Viewer:Linearization:Linearized:False"),h._sendMessage({type:"Linearization",linearized:n},l.origin)}catch(e){A("DCBrowserExt:Viewer:Linearization:Linearized:Detection:Failed"),G("Linearization Detection failed",e)}}class re{constructor(){this.request={main_op:"analytics"}}analytics=e=>{this.request.analytics||(this.request.analytics=[]),this.request.analytics.push([e])};sendAnalytics=()=>{k(this.request)}}function ie(t,a,r,i){return s=>{try{if(s.data&&s.origin&&V(s.origin)&&(e=>{try{return e&&e.source&&e.source.top.location.origin==="chrome-extension://"+chrome.runtime.id}catch(e){return!1}})(s)){if(s.data.main_op)return ne(t,s);switch(s.data.type){case"ready":if(_?function(t,n,a,r){let i=new re;p=!0;const s=m;document.title=d;const o=r.responseHeaders["Accept-Ranges"],l=!(!o||"bytes"!==o.toLowerCase())&&"true";t.sendFileMetaData("metadata",f,r.responseHeaders["Content-Length"],l,s,d,n.origin,!1),ce(),a?(i.analytics("DCBrowserExt:Viewer:Linearization:Range:Supported"),a.then((e=>{t.sendInitialBuffer("initialBuffer",e.startTime,e.endTime,e.buffer,n.origin),ae(e)})).catch((e=>{t.sendInitialBuffer("initialBuffer",0,0,-1,n.origin),i.analytics("DCBrowserExt:Viewer:Error:Linearization:InitialBufiled")}))):i.analytics("DCBrowserExt:Viewer:Linearization:Range:Not:Supported"),e.removeItem("isReload"),e.removeItem("isBackForward");const g=window.performance&&window.performance.timing&&window.performance.timing.navigationStart;fetch(r.streamUrl).then((e=>{let a=0;return new Response(new ReadableStream({start(i){const s=e.body.getReader();!function e(){s.read().then((({done:s,value:o})=>{s?i.close():(a+=o.byteLength,t.sendProgress("progress",r.responseHeaders["Content-Length"],a,n.origin),i.enqueue(o),e())})).catch((e=>{i.error(e)}))}()}}))})).then((e=>e.arrayBuffer())).then((a=>{c=a.byteLength,t.preview("preview",a,a.byteLength,d,g,(new Date).getTime(),n.origin),h._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},n.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&h._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},n.origin)})).catch((e=>(i.analytics("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),M()))),i.sendAnalytics(),G("Viewer loaded")}(t,s,r,a):function(t,n,a,r,i){p=!0;const s=m,o=T("chunk")||"false",g=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("reload"),u=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("back_forward");t.sendFileMetaData("metadata",f,c,o,encodeURI(s),d,n.origin,g||u),ce(),a?(A("DCBrowserExt:Viewer:Linearization:Range:Supported"),a.then((e=>{t.sendInitialBuffer("initialBuffer",e.startTime,e.endTime,e.buffer,n.origin),ae(e)})).catch((e=>{t.sendInitialBuffer("initialBuffer",0,0,-1,n.origin),A("DCBrowserExt:Viewer:Error:Linearization:InitialBuffer:Failed")}))):(A("DCBrowserExt:Viewer:Linearization:Range:Not:Supported"),t.sendInitialBuffer("initialBuffer",0,0,-1,n.origin)),r.then((a=>{const r=a.downLoadEndTime,s=a.buffer;a.buffer.byteLength,t.preview("preview",s,c,d,i,r,n.origin),h._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},l.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&h._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},l.origin)})).catch((e=>(A("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),M()))),G("Viewer loaded")}(t,s,r,a,i),s.data.visitorID){const t=e.getItem("viewerVisitorID");e.setItem("viewerVisitorID",s.data.visitorID),t&&t!==s.data.visitorID&&A("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}break;case"getFileBufferRange":!function(e,t){Z({url:m},e.data.range).then((n=>{y||(A("DCBrowserExt:Viewer:Linearization:Range:Called"),y=!0),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,n.buffer,e.origin)})).catch((n=>{A("DCBrowserExt:Viewer:Error:Linearization:Range:Failed"),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,-1,e.origin)}))}(s,t);break;case"previewFailed":b||(A("DCBrowserExt:Viewer:Error:FallbackToNative:Preview:Failed"),b=!0,M());break;case"signin":A("DCBrowserExt:Viewer:Ims:Sign:In"),H();break;case"signout":A("DCBrowserExt:Viewer:Ims:Sign:Out"),e.removeItem("viewer-locale"),e.removeItem("userDetailsFetchedTimeStamp"),e.removeItem("discoveryExpiryTime"),e.removeItem("viewer-locale"),z();break;case"coachMarkClosed":e.setItem("staticFteCoachmarkShown","true"),A("DCBrowserExt:Staticpdf:fte:CoachMark:Closed");break;case"coachmarkManageSettings":chrome.runtime.openOptionsPage(),e.setItem("staticFteCoachmarkShown","true"),A("DCBrowserExt:Staticpdf:fte:CoachMark:ManageSettings:clicked");break;case"coachMarkDisplayed":e.setItem("staticFteCoachmarkShown","true"),A("DCBrowserExt:Staticpdf:fte:CoachMark:Shown");break;case"googleAppsPrintShown":n.setItem("googleAppsPrint","false"),A("DCBrowserExt:Viewer:GoogleApps:Print:Shown");break;case"signInExperimentShown":chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const n=t[0],a=(new Date).getTime();e.setItem("signInExperimentShown",JSON.stringify({currTabId:n.id,timestamp:a}))}));break;case"disableViewer":e.setItem("pdfViewer","false"),chrome.tabs.reload();break;case"signInExperimentClosed":case"signInExperimentSkipped":e.setItem("signInExperimentSuppressed","true");break;case"enableBeta":e.setItem("betaOptOut","false"),chrome.tabs.reload();break;case"disableBeta":e.setItem("betaOptOut","true"),chrome.tabs.reload()}}}catch(e){A("DCBrowserExt:Viewer:Error:MessageHandler:Unknown")}}}function se(){if(!u)return A("DCBrowserExt:Viewer:Error:Handshake:TimedOut"),M(),!1}const oe=t=>{try{const n=t.responseHeaders["Content-Length"];c=n;const a=t.responseHeaders["Accept-Ranges"],r=a&&"bytes"===a.toLowerCase();m=t.originalUrl,Y(),d=function(e){let t;const n=e.responseHeaders["Content-Disposition"];if(n&&/\.pdf(["']|$)/i.test(n)){const e=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(n);null!=e&&e.length>1&&(t=e[1].replace(/['"]/g,""))}return t||(t=X(m)),decodeURIComponent(t)}(t);const i={url:m},s=new URL(e.getItem("cdnUrl"));l||(l=s);let o=null;const g="false"!==T("linearization");g&&r&&n>0&&(o=Z(i,{start:0,end:1024})),window.addEventListener("message",ie(h,t,o)),le(),setTimeout(se,25e3)}catch(e){G("InitMimeHandlerScript failed",e),M()}};function ce(){if(n.getItem("signInAction")){const e=n.getItem("signInAction");h._sendMessage({type:"signInInformation",action:e,source:"signIn"===e?n.getItem("signInSource"):n.getItem("signUpSource")},l.origin),n.removeItem("signInSource"),n.removeItem("signUpSource"),n.removeItem("signInAction")}}async function le(){chrome.storage.onChanged.addListener(((t,n)=>{"local"===n&&Object.entries(t).forEach((([t,{newValue:n}])=>{if("theme"===t&&h._sendMessage({type:"themeChange",theme:n},l.origin),"ANALYTICS_OPT_IN_ADMIN"===t){const t="false"!==e.getItem("logAnalytics"),a="false"!==n;h._sendMessage({type:"analyticsTrackingChange",value:t&&a},l.origin)}"saveLocation"===t&&h._sendMessage({type:"changeSaveLocationPreference",saveLocation:n},l.origin)}))})),await async function(){return o=await i.isInstalledViaUpsell(),o}(),k({main_op:"viewer-startup",url:m,startup_time:Date.now(),viewer:!0},(e=>{W.isSharePointURL=!!e.isSharePointURL,W.isSharePointFeatureEnabled=!!e.isSharePointEnabled,W.isFrictionlessEnabled=!!e.isFrictionlessEnabled,W.featureFlags=e.featureFlags,W.isFillAndSignRegisteryEnabled=e.isFillnSignEnabled;const t=O().href;h.sendStartupConfigs(t,l.origin)})),k({main_op:"get-features&groups",cachePurge:"LAZY"},(e=>{h._sendMessage({type:"featureGroups",featureGroups:e.featureGroups,featureFlags:e.featureFlags},l.origin)})),_&&(setTimeout(K,2e3),function(){const t=e.getItem("recentFilesData");if(t&&t.isSyncedWithHistory){const n=t.recentFilesPath?[...t.recentFilesPath]:[];1e3===n.length&&n.shift(),n.push({url:m,filename:d,lastVisited:Date.now()}),t.recentFilesPath=n,e.setItem("recentFilesData",t)}else chrome.permissions.contains({permissions:["history"],origins:["https://www.google.com/"]},(t=>{if(t)chrome.history.search({text:chrome.runtime.getURL("viewer.html"),startTime:0,maxResults:999},(t=>{const n=t.filter((e=>e.url.startsWith(chrome.runtime.getURL("viewer.html")))),a=[];for(let e=n.length-1;e>=0;e--){const{url:t,title:r,lastVisitTime:i}=n[e];let s=t;const o=t.split("viewer.html");o[1]&&(s=B(o[1],"pdfurl"),a.push({url:s,filename:r,lastVisited:i}))}a.push({url:m,filename:d,lastVisited:Date.now()}),e.setItem("recentFilesData",{recentFilesPath:a,isSyncedWithHistory:!0})}));else{const t=[];t.push({url:m,filename:d,lastVisited:Date.now()}),e.setItem("recentFilesData",{recentFilesPath:t,isSyncedWithHistory:!0})}}))}())}function de(e){const t=document.getElementById("__acrobatDialog__");t&&0!==t.length?t&&"none"===t.style.display&&"visible"===e.frame_visibility?t.style.display="block":t&&e.trefoilClick&&(delete e.trefoilClick,t.remove()):function(e){const t=e.base64PDF;delete e.base64PDF;const n=`message=${encodeURIComponent(JSON.stringify(e))}`;e.base64PDF=t;const a=null===e.locale;let r=e.version>13||a?"210px":"130px",i="block";"hidden"===e.frame_visibility&&(i="none");const s=document.createElement("iframe");s.setAttribute("src",`${chrome.runtime.getURL("browser/js/frame.html")}?${n}`),s.setAttribute("id","__acrobatDialog__"),s.style.border="0px",s.style.zIndex="999999999999",s.style.position="fixed",s.style.top="-5px",s.style.right="80px",s.style.width="294px",s.style.height=r,s.style.display=i,s.style.margin="auto",document.getElementById("trefoil_m").appendChild(s)}(e)}function me(e){k({main_op:"caret_mode_toggle_handler",toggleCaretModeValue:e})}function ge(e){if(e.panel_op&&(1==e.trefoilClick?(delete e.trefoilUI,delete e.newUI,de(e)):!0===e.reload_in_native&&(delete e.is_viewer,chrome.tabs.reload(e.tabId))),"relay_to_content"!==e.main_op||"dismiss"!==e.content_op)return"relay_to_content"===e.main_op&&"caret_mode_toggle_handler"===e.content_op?h._sendMessage({type:"toggleCaretMode",toggleCaretModeValue:e.status},l.origin):"reset"===e.main_op?h._sendMessage({type:"toggleAnalytics",logAnalytics:e.analytics_on},l.origin):"showUninstallPopUp"===e.main_op&&h._sendMessage({type:"showUninstallPopUp"},l.origin),!1;{delete e.content_op,delete e.trefoilClick,delete e.reload_in_native;let t=document.getElementById("__acrobatDialog__");t&&(t.remove(),t=null)}}document.addEventListener("DOMContentLoaded",function(e){const t=(new Date).getTime();let n=window.setInterval((function(){(function(){const e=document.getElementById("dc-view-frame");return e&&e.contentWindow&&1===e.contentWindow.length}()||(new Date).getTime()-t>15e3)&&(window.clearInterval(n),e.call(this))}),200)}((function(){const e=document.getElementById("dc-view-frame");e&&e.contentWindow&&e.contentWindow.focus()}))),void 0!==chrome.runtime&&i.isMimeHandlerAvailable().then((async function(t){if(chrome.runtime.onMessage.addListener(ge),t){if(_=!0,!window.navigator.onLine&&e.getItem("offlineSupportDisable"))return void M();const t=await i.getStreamInfo()||{};v=t.tabId;let n=await k({main_op:"check-is-google-print"});S=n&&n.isGooglePrint,E=await i.caretModeStatus(),i.addCaretModeListener(me),k({main_op:"viewer-preview",startup_time:Date.now(),viewer:!0},(()=>oe(t)))}else F(),(()=>{try{if(!x(m))return void(g=!1);Y();const t=T("clen")||-1,n=T("chunk")||!1,a="false"!==T("linearization"),r={url:m},i=(new Date).getTime(),s=new URL(e.getItem("cdnUrl"));d=T("pdffilename")||X(m),document.title=decodeURIComponent(d),l||(l=s);let o=null;const c=a&&n&&t>0;c&&(o=Z(r,{start:0,end:1024}));const p=ee(h,c,s.origin);window.addEventListener("message",ie(h,p,o,i)),setTimeout(se,25e3)}catch(e){G("InitScript failed",e),M()}})(),le()}))}();