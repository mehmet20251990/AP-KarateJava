/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{events as e}from"../../common/analytics.js";import{dcLocalStorage as t}from"../../common/local-storage.js";import{util as s}from"./content-util.js";import{privateApi as n}from"./content-privateApi.js";import{OptionPageActions as a}from"../../common/constant.js";await t.init(),$((function(){const i="analyticsOptinTitle",r="web2pdfOptOut",o="web2pdfOptOutDisabled",c="LearnMoreURL",l="web2pdfPrivacy",p="web2pdfShowPDFTools",d="web2pdfFrictionlessToggleDescription",h="pdfOwnershipExploreOptionsTitle",u="pdfOwnershipExploreOptionsDescription",S="web2pdfOpenConvertedPDFTitle",E="web2pdfOpenConvertedPDFDescription",I="web2pdfShowPersistentOpen",f="web2pdfShowPersistentOpenDescription",T="optionsSuccessPrompt",g="optionsFailurePrompt",m="appearancePrefTitle",_="appearancePrefDesc",v="appearancePrefOp1",P="appearancePrefOp2",O="appearancePrefOp3",N="saveLocationPreferenceTitle",A="saveLocationPreferenceDescription",D="saveLocationOp1",b="saveLocationOp2",w="saveLocationOp3";let L=[],R={},y=null;class C{constructor(){this.ID="#web2pdfSaveButton",this.closePromptID="#prompt-close",this.enableState=!1,this.optionStates=new Set,this.timeoutId=null,$(this.ID).click((e=>this.SavePreferences(e))),$(this.closePromptID).click((e=>this.HideSavedPrompt(e)))}Reset(){this.enableState=!1,this.optionStates.clear(),$(this.ID).prop("disabled",!0)}setEnabled(e){this.optionStates.add(e),$(this.ID).prop("disabled",!1),this.enableState=!0}setDisabled(e){this.optionStates.has(e)&&(this.optionStates.delete(e),0===this.optionStates.size&&($(this.ID).prop("disabled",!0),this.enableState=!1))}GetState(){return this.enableState}SavePreferences(){const e={analytics:[]};for(const t in R)R[t].hasUpdated&&(e[t]=R[t].GetCurrentState());const n=L.find((e=>"pdfViewer"===e.storageKey&&e.hasUpdated));if(n){let e;!0===n.currentState||"true"===n.currentState?(t.setItem("viewer-enabled-source","ownership-consent"),e="true"):e="false",s.isEdge()&&s.messageToMain({main_op:"pdfViewerChanged",value:e})}R.environment&&R.environment.hasUpdated&&s.messageToMain({main_op:"init-floodgate"}),L.filter((e=>e.hasUpdated)).map((e=>e.SavePreferences())).filter((e=>e)).forEach((t=>e.analytics.push(t))),function(e,t){s.messageToMain({main_op:"save-preferences",...e},t)}(e,(e=>{e.success?this.ShowSavedPrompt(!0):this.ShowSavedPrompt(!1),this.Reset(),K((async e=>{H(e.settings),await W(e),V()}))}))}ShowSavedPrompt(e){const t=$("#savePrompt"),n=$(".prompt"),a=$("#optionsSuccessPrompt");e?(a.text(s.getTranslation(T)),n.removeClass("failure")):(a.text(s.getTranslation(g)),n.addClass("failure")),t.show(),this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout((e=>this.HideSavedPrompt()),5e3)}HideSavedPrompt(){$("#savePrompt").hide()}}class B{constructor(e,s,n,a){this.titleId=e,this.descriptionId=s,this.storageKey=a,this.defaultState=t.getItem(this.storageKey)||n,this.currentState=this.defaultState,this.hasUpdated=!1,this.savePreferencesButton=null}AttachEventHandler(e){this.savePreferencesButton=e}RenderInputItem(){return $("<div/>")}Render(){const e=$("<div/>",{class:"option"}),t=$("<label/>",{class:"label",for:this.titleId}),n=$("<span/>",{class:"label-title",text:s.getTranslation(this.titleId)||this.titleId,id:this.titleId}),a=$("<span/>",{class:"label-description",text:s.getTranslation(this.descriptionId)||this.descriptionId,id:this.descriptionId});t.append(n),t.append(a),e.append(t);const i=this.RenderInputItem();return e.append(i),e}GetCurrentState(){return this.currentState}SavePreferences(){this.hasUpdated&&(this.storageKey&&(console.log("Updating Preference for ",this.storageKey,"from",t.getItem(this.storageKey,this.defaultState),"to",this.currentState),"pdfViewer"===this.storageKey&&(t.getWithTTL("ownership-upgrade")&&!1===this.currentState&&(s.messageToMain({main_op:"analytics",analytics:[[e.USE_ACROBAT_VIEWER_DISABLED_DEFAULT_OWNERSHIP_EXPERIMENT,{SOURCE:"OptionsPage",EXPERIMENT:t.getItem("experiment-ownership")}],[e.USE_ACROBAT_VIEWER_DISABLED_DEFAULT_OWNERSHIP,{SOURCE:"OptionsPage"}]]}),t.removeItem("ownership-upgrade"),t.removeItem("defaultOwnerShipExperiment")),n.setViewerState(!0===this.currentState?"enabled":"disabled")),t.setItem(this.storageKey,String(this.currentState))),this.hasUpdated=!1,this.defaultState=this.currentState)}}class M extends B{constructor(e,s,n,a,i,r){super(e,s,n,a),this.defaultState=function(e,s=!1){const n=t.getItem(e);return n&&""!==n?"true"===n:s}(this.storageKey,n),this.currentState=this.defaultState,this.analyticsId={enabled:i,disabled:r}}onToggleChange(e){const t=$(e.currentTarget);this.currentState=!t.hasClass("checked"),this.hasUpdated=!this.hasUpdated,t.toggleClass("checked"),this.savePreferencesButton&&this.currentState===this.defaultState?this.savePreferencesButton.setDisabled(this.titleId):this.savePreferencesButton.setEnabled(this.titleId)}RenderDisabledInputItem(){const e=$("<span/>"),t=$("<button/>",{class:"option-toggle-disabled"});return e.append(t),e}RenderInputItem(){const e=$("<span/>"),t=$("<button/>",{class:"option-toggle"});return t.click((e=>this.onToggleChange(e))),this.currentState&&t.addClass("checked"),e.append(t),e}GetAnalytics(){return this.currentState?this.analyticsId.enabled:this.analyticsId.disabled}SavePreferences(){return super.SavePreferences(),this.GetAnalytics()}}class U extends B{constructor(e,s,n,a,i,r,o){super(e,s,a,i),this.valuesMap=n,this.onSavePreferences=r,o&&!t.getItem(i)&&t.setItem(i,String(a))}onSelectionChange(e){this.currentState=$(e.currentTarget).val(),this.currentState===this.defaultState?(this.hasUpdated=!1,this.savePreferencesButton&&this.savePreferencesButton.setDisabled(this.titleId)):(this.hasUpdated=!0,this.savePreferencesButton&&this.savePreferencesButton.setEnabled(this.titleId))}RenderInputItem(){const e=$("<span/>"),t=$("<select/>",{class:"option-select"});for(const e in this.valuesMap){const s=$("<option/>",{value:e,text:this.valuesMap[e]});t.append(s)}return t.change((e=>this.onSelectionChange(e))),this.currentState&&t.val(this.currentState),e.append(t),e}SavePreferences(){const e=this.defaultState;super.SavePreferences(),this.onSavePreferences&&this.onSavePreferences(this.currentState,e)}}class G extends M{constructor(){let s="false"===t.getItem("ANALYTICS_OPT_IN_ADMIN")?o:r;super(i,s,!0,"logAnalytics",e.OPTIONS_ENABLED_ANALYTICS,e.OPTIONS_DISABLED_ANALYTICS),this.learnMoreLink=c,this.learnMoreTitle=l}Render(){const n=$("<div/>",{class:"option"}),a=$("<label/>",{class:"label",for:this.titleId}),i=$("<span/>",{class:"label-title",text:s.getTranslation(this.titleId),id:this.titleId}),r=$("<span/>",{class:"label-description",text:s.getTranslation(this.descriptionId)+" ",id:this.descriptionId}),o=$("<a/>",{class:"learn-more",href:s.getTranslation(this.learnMoreLink),text:s.getTranslation(this.learnMoreTitle),target:"_blank"});let c;return o.click((function(){s.messageToMain({main_op:"analytics",analytics:[[e.OPTIONS_ABOUT_ADOBE_ACROBAT_CLICKED]]})})),a.append(i),a.append(r),n.append(a),"false"===t.getItem("ANALYTICS_OPT_IN_ADMIN")?c=this.RenderDisabledInputItem():(c=this.RenderInputItem(),r.append(o)),n.append(c),n}SavePreferences(){if(this.hasUpdated)return this.hasUpdated=!1,this.defaultState=this.currentState,this.GetAnalytics()}}function F(e){return e.version>13}function k(e){return 13==e.version}function x(){const e=t.getItem("fteDenied")||"0",s="false"===t.getItem("pdfViewer");return SETTINGS.VIEWER_SHOW_OPEN_IN_ACRO&&(10===parseInt(e)||s)}function H(e){if(e&&e.settings){for(const t in e.settings)SETTINGS[t]=e.settings[t];(function(e){return null===e.locale})(e)&&(SETTINGS.FRICTIONLESS_ENABLED=!1)}}function V(){null==y&&(y=new C);const e=$("#toggles");$("#progress").remove(),e.empty(),L.forEach((t=>{t.AttachEventHandler(y);const s=t.Render();e.append(s)}))}async function W(a){L=[],R={};const i=new G,r=new M(p,d,!0,"always-show-pdftools",e.FRICTIONLESS_AUTO_SUGGESTION_ENABLED,e.FRICTIONLESS_AUTO_SUGGESTION_DISABLED),o=new M(h,u,!1,"pdfViewer",e.USE_ACROBAT_IN_CHROME_ENABLED,e.USE_ACROBAT_IN_CHROME_DISABLED),c=new M(S,E,!0,"ViewResultsPref",e.TREFOIL_HTML_OPENPDF_PREF_ON,e.TREFOIL_HTML_OPENPDF_PREF_OFF),l=new M(I,f,!0,"always-show-pdf-menu",e.OPTIONS_ENABLED_OPEN_IN_ACROBAT,e.OPTIONS_DISABLED_OPEN_IN_ACROBAT);if(F(a)?(L.push(c),SETTINGS.VIEWER_ENABLED&&SETTINGS.VIEWER_ENABLED_FOR_ACROBAT?(L.push(o),x()&&L.push(l)):L.push(l)):k(a)?await async function(){const e=await async function(){return!(s.isEdge()&&await n.isMimeHandlerAvailable()&&t.getItem("openInAcrobatEnable")&&"admin"!==t.getItem("installSource"))}();SETTINGS.VIEWER_ENABLED?(L.push(o),SETTINGS.FRICTIONLESS_ENABLED&&!s.isEdge()&&L.push(r),x()&&e&&L.push(l)):(SETTINGS.FRICTIONLESS_ENABLED&&!s.isEdge()&&L.push(r),e&&L.push(l))}():(SETTINGS.VIEWER_ENABLED&&L.push(o),SETTINGS.FRICTIONLESS_ENABLED&&!s.isEdge()&&L.push(r)),!0===t.getItem("isModernViewerEnable")&&!0===t.getItem("darkModeEnable")){const y=s.getTranslation(v),C=s.getTranslation(P),B=s.getTranslation(O);function T(t,n){s.messageToMain({main_op:"themeChange",analytics:[[e.OPTIONS_APPEARENCE_THEME_CHANGED,{OLDTHEME:n,NEWTHEME:t}]]})}const $=new U(m,_,{auto:y,dark:C,light:B},"auto","theme",T,!0);L.push($)}if(!0===t.getItem("isSaveLocationPrefEnabled")){const H=s.getTranslation(D),V=s.getTranslation(b),W=s.getTranslation(w);function g(n,a){s.messageToMain({main_op:"analytics",analytics:[[e.SAVE_LOCATION_PREFERENCE_CHANGED,{OLDPREF:a,NEWPREF:n}]]}),t.setItem("selectedSaveLocationPreference",!0)}const K=new U(N,A,{ask:H,cloud:V,local:W},"ask","saveLocation",g,!0);L.push(K)}L.push(i),R.analytics_on=i,function(e){if(SETTINGS.DEBUG_MODE){function t(e){s.messageToMain({panel_op:"common",requestType:"update_env",env:e})}const n=new U("Development Environment","Select the target environment for the extension.",{prod:"Production",stage:"Stage",test:"Test",dev:"Dev","local-dev":"Local Dev"},e.environment||"prod","env",t),a=F(e)?"acrobat":k(e)?"reader":"no-app",i=new U("Connected Application","Select the target connected application for the extension functionalities. This settings only mock the views, the functionality may be broken.",{acrobat:"Acrobat",reader:"Reader","no-app":"No App"},a||"acrobat");L.push(n,i),R.environment=n,R.product=i}}(a)}function K(e){s.messageToMain({main_op:"fetch-preferences"},e)}function j(e){const t=L.filter((t=>t.titleId===e));return t.length>0?t[0]:null}function q(e,t,s){if(SETTINGS.TEST_MODE)return;const n=e.toggleId,i=j(n),r=e.requestType;let o,c;if(r===a.OPTIONS_UPDATE_TOGGLE){const t="true"===e.toggleVal;i?(i.currentState=t,i.savePreferencesButton.SavePreferences(),o=i.currentState):c="Toggle not visible.",s&&s({requestType:r,toggleId:n,response:o,error:c})}}$(document).ready((function(){s.translateElements(".translate"),K((async e=>{H(e),await W(e),V(),s.addMainListener(q),function(){if(!SETTINGS.TEST_MODE)return;const e="check_toggle_state",t="update_toggle_state";chrome.runtime.onMessage.addListener((function(s,n,a){if(!s.panel_op||"test"!==s.panel_op)return;const i=s.test_extension,r=s.toggleId,o=j(r);let c,l;switch(i){case e:o?c=o.currentState:l="Toggle not visible.";break;case t:const n="true"===s.toggleVal;o?(o.currentState=n,o.hasUpdated=!0,o.savePreferencesButton.SavePreferences(),c=o.currentState):l="Toggle not visible.";break;default:l="Invalid request type."}a({requestType:i,toggleId:r,response:c,error:l})}))}()}))}))}));