/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as n}from"../../common/local-storage.js";import{events as e}from"../../common/analytics.js";await n.init();export const util={analytics:function(n,e,t){n.analytics||(n.analytics=[]),n.analytics.push([e,t])},messageToMain:function(n,e){chrome.runtime.sendMessage(n,e)},addMainListener:function(n){chrome.runtime.onMessage.addListener(n)},isChrome:function(){return!0},isEdge:function(){try{if("true"===n.getItem("IsRunningInEdge"))return!0}catch(n){}let e=window.navigator.userAgent.toLowerCase();return-1!==e.indexOf("chrome")&&-1!==e.indexOf("edg/")},isChromeOnlyMessage:function(n){return-1!==["web2pdfMissingMac","web2pdfFrictionlessUrl","web2pdfBadVersion","pdfOwnershipExploreAcrobat","pdfOwnershipPromptContent","LearnMoreURL"].indexOf(n)},consoleLog:function(n){SETTINGS.DEBUG_MODE&&console.log(n)},consoleLogDir:function(n){SETTINGS.DEBUG_MODE&&console.dir(n)},consoleError:function(n){SETTINGS.DEBUG_MODE&&console.error(n)},getTranslation:function(n,e){return util&&util.isChromeOnlyMessage(n)&&util.isEdge()&&(n+="Edge"),e?chrome.i18n.getMessage(n,e):chrome.i18n.getMessage(n)},translateElements:function(n){$(n).each((function(){"INPUT"===this.tagName?$(this).val(util.getTranslation(this.id)):$(this).text(util.getTranslation(this.id))}))},isPDFForm:function(n){let e=/.+?\:\/\/.+?(\/.+?)(?:#|\?|$)/.exec(n),t="";if(null===e||e.length<2)return!1;if(t=e[1].endsWith("/")?e[1].slice(0,-1):e[1],void 0===t||0==t.length)return!1;t=t.toLowerCase();let i=t.split("/"),o=i[i.length-1];function r(n){return o.indexOf(n)>-1}return!["forms","guide","summary","process","sample","procedure","requirement","example","instr","format","formul","reform","forming","former","formed"].some(r)&&(!!(i.length>1&&(i.pop(),i.includes("form")||i.includes("forms")))||["form","application.pdf"].some(r))},logSharePointAnalytics:function(n,t){SETTINGS.FILL_N_SIGN_ENABLED&&"FillnSign"===n.paramName?t?n.version===SETTINGS.READER_VER?util.analytics(n,e.TREFOIL_FILLSIGN_READER_SHAREPOINT):util.analytics(n,e.TREFOIL_FILLSIGN_ACROBAT_SHAREPOINT):n.version===SETTINGS.READER_VER?util.analytics(n,e.PERSIST_FILLSIGN_READER_SHAREPOINT):util.analytics(n,e.PERSIST_FILLSIGN_ACROBAT_SHAREPOINT):t?n.version===SETTINGS.READER_VER?util.analytics(n,e.TREFOIL_PDF_READER_SHAREPOINT):util.analytics(n,e.TREFOIL_PDF_ACROBAT_SHAREPOINT):n.version===SETTINGS.READER_VER?util.analytics(n,e.PERSIST_PDF_READER_SHAREPOINT):util.analytics(n,e.PERSIST_PDF_ACROBAT_SHAREPOINT)},logOpenInAcrobatAnalytics:function(n,t){let i=e.PERSIST_PDF_ACROBAT;i=SETTINGS.FILL_N_SIGN_ENABLED&&"FillnSign"===n.paramName?t?n.version===SETTINGS.READER_VER?e.TREFOIL_PDF_READER_FS:e.TREFOIL_PDF_ACROBAT_FS:n.version===SETTINGS.READER_VER?e.PERSIST_PDF_READER_FS:e.PERSIST_PDF_ACROBAT_FS:t?n.version===SETTINGS.READER_VER?e.TREFOIL_PDF_READER:e.TREFOIL_PDF_ACROBAT:n.version===SETTINGS.READER_VER?e.PERSIST_PDF_READER:e.PERSIST_PDF_ACROBAT,util.analytics(n,i)},handleXHRRequest:function(n,e,t,i){let o=new XMLHttpRequest;o.onreadystatechange=function(){o.readyState===XMLHttpRequest.DONE&&(200===o.status?i(null,o):i(o.status,null))},o.ontimeout=function(n){i(n,null)},o.onerror=function(n){i(n,null)},o.open(n,e,!0),o.send(t)},handlePDFURL:async function(n,e=!0){if(!0===SETTINGS.SHAREPOINT_ENABLED){if(n.isSharePointURL)return util.logSharePointAnalytics(n,e),n;{const t=await util.checkForSharePointURL(n.url);return n.isSharePointURL=t,t?util.logSharePointAnalytics(n,e):util.logOpenInAcrobatAnalytics(n,e),n}}return n.isSharePointURL=!1,util.logOpenInAcrobatAnalytics(n,e),n},checkForSharePointURL:function(n){return new Promise((e=>{util.handleXHRRequest("OPTIONS",n,null,((t,i)=>{if(!t&&i){let t=i.getResponseHeader("MicrosoftSharepointTeamServices"),o=i.getResponseHeader("MS-Author-Via");if(t&&o&&o.includes("MS-FP/4.0")){const t=new URL(n),i=t.protocol+"//"+t.hostname+":"+t.port+"/_vti_inf.html";return void util.handleXHRRequest("GET",i,null,((n,t)=>{if(!n&&t){let n=t.response;if(n.includes("FPAuthorScriptUrl")&&n.includes("FPAdminScriptUrl"))return void e(!0)}e(!1)}))}}e(!1)}))}))},uuid:function(){try{let n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"===e?t:3&t|8).toString(16)}))}catch(n){return Math.random()}}};