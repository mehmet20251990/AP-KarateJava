/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{communicate as e}from"./communicate.js";import{util as t}from"./util.js";import{analytics as n}from"../common/analytics.js";import{acroActions as o}from"./acro-actions.js";import{SETTINGS as a}from"./settings.js";import{dcLocalStorage as s,dcSessionStorage as r}from"../common/local-storage.js";import{floodgate as i}from"./floodgate.js";import{privateApi as l}from"./private-api.js";import{common as c}from"./common.js";import{userSubscription as m}from"./user-subscription.js";var E,d,I=new Promise((function(e){d=e})),u={},_=()=>e.getModule("acro-web2pdf"),p=()=>e.getModule("acro-gstate"),f=["http://*/*","https://*/*"];async function T({locale:e}={}){const n=s.getItem("installSource");if(["development","normal","sideload"].includes(n)){const n=new URL(c.getUninstallUrl());if(e)n.searchParams.append("locale",e);else{let e=s.getItem("viewer-locale");e||(e=t.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"))),n.searchParams.append("locale",e)}n.searchParams.append("theme",s.getItem("theme")||"auto"),n.searchParams.append("callingApp",chrome.runtime.id),chrome.runtime.setUninstallURL(n.href)}}async function g(e){try{e&&("update"===e.reason?(t.verCmp(e.previousVersion,"15.1.3.30")<0?(n.event(n.e.LOCAL_STORAGE_MIGRATION_INIT),await async function(){let e;try{const o=await chrome.tabs.query({});await Promise.allSettled(o.map((({id:e})=>chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/injectCopyLSIframe.js"]})))),await t.sleep(300),e=await chrome.runtime.sendMessage({main_op:"copy-ls"}),o.map((({id:e})=>chrome.tabs.sendMessage(e,{content_op:"remove-lsCopy"}).catch((()=>null))))}catch(e){}finally{"succeed"!==e?(s.setItem("retryOnNextPage",!0),n.event(n.e.LOCAL_STORAGE_MIGRATION_FAILED)):n.event(n.e.LOCAL_STORAGE_MIGRATION_SUCCESS)}}()):n.event(n.e.LOCAL_STORAGE_ALREADY_MIGRATED),s.getItem("installVersion")||s.setItem("installVersion",e.previousVersion),s.setItem("installType",e.reason)):"install"===e.reason&&((()=>{const e=`https://chrome.google.com/webstore/detail/*/${chrome.runtime.id}*`,t=`https://microsoftedge.microsoft.com/addons/detail/*/${chrome.runtime.id}*`;chrome.tabs.query({url:[e,t]},(e=>{if(chrome.runtime.lastError)E=null;else for(let t in e){const n=new URLSearchParams(new URL(e[t].url).search);if(n.has("mv")){E=encodeURIComponent(n.get("mv"));break}}}))})(),s.setItem("installVersion",chrome.runtime.getManifest().version),s.setItem("installType",e.reason)),s.getItem("offlineSupportDisable")||s.setItem("offlineSupportDisable",!0)),I.then((({env:o,msg:r})=>{if(s.setItem("installSource",o.installType),T(),"update"===e.reason)n.event(n.e.EXTENSION_UPDATE);else if("install"===e.reason){switch(n.event(n.e.EXTENSION_INSTALLED),o.installType){case"admin":n.event(n.e.EXTENSION_INSTALLED_ADMIN);break;case"development":n.event(n.e.EXTENSION_INSTALLED_DEVELOPMENT);break;case"other":n.event(n.e.EXTENSION_INSTALLED_OTHER);break;case"normal":l.isInstalledViaUpsell().then((e=>{if(e)n.event(n.e.EXTENSION_INSTALLED_UPSELL);else{n.event(n.e.EXTENSION_INSTALLED_DIRECT);let e="store_direct";E&&(e=decodeURIComponent(E)),n.event(n.e.EXTENSION_INSTALLED_SOURCE,{SOURCE:e})}}));break;case"sideload":n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED),r.installMonth&&r.installYear?n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED_MONTH_YEAR,{MONTH:r.installMonth,YEAR:r.installYear}):n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED_MONTH_YEAR,{MONTH:"None",YEAR:"None"}),a.IS_READER&&"win"===a.OS&&n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED_SOURCE,{SOURCE:r.source});break;default:n.event(n.e.EXTENSION_INSTALLED_DEFAULT)}!function(e){if("false"!==s.getItem("fte")){const o=i.hasFlag("dc-cv-modern-viewer");setTimeout((()=>{chrome.storage.managed.get("OpenHelpx",(function(a){const r=!a||"false"!==a.OpenHelpx;n.event(r?n.e.VIEWER_FTE_OPEN_HELPX_ENABLED:n.e.VIEWER_FTE_OPEN_HELPX_DISABLED),function(){try{s.getItem("pdfViewer")||(s.setItem("viewer-enabled-source","ownership-install"),s.setItem("pdfViewer","true"),l.setViewerState("enabled"),t.isEdge()?(m.initiateUserPolling(),n.event(n.e.USE_ACROBAT_IN_EDGE_AUTO_ENABLED)):n.event(n.e.USE_ACROBAT_IN_CHROME_AUTO_ENABLED))}catch(e){n.event(n.e.LOCAL_STORAGE_DISABLED)}}(),s.setItem("fte","false");const i=t.isEdge()&&("admin"===e.installType||"sideload"===e.installType);r&&!i&&async function(e){const n=await Promise.any([e,new Promise((e=>setTimeout(e,1e3,!0)))]);s.setItem("modernViewerEnable",!!n);const o=n?"mv":"cv";let a=chrome.i18n.getMessage("@@ui_locale");["ca","da","en_GB","es","fi","hr","it","ko","nl","pt_BR","ru","sl","tr","zh_CN","cs","de","en_US","eu","fr","hu","ja","nb","pl","ro","sk","sv","uk","zh_TW"].includes(a)||(a="en_US");const r=t.isEdge()?"Edge":"Chrome";t.isEdge()||s.setItem("staticFteCoachmarkShown","false");return`${c.getWelcomePdfUrlHost()}/dc-chrome-extension/${o}/${a}/Acrobat-for-${r}.pdf`}(o).then((e=>t.createTab(e,(e=>{const t=(new Date).getTime();function o(t,a){e.id==t&&"complete"===a.status&&(n.event(n.e.WELCOME_PDF_LOADED),chrome.tabs.onUpdated.removeListener(o))}u={...e,timestamp:t},chrome.tabs.onUpdated.addListener(o)}))))}))}),2e3)}}(o)}}))}catch(e){}}function N(){try{if(navigator.onLine||!1===s.getItem("offlineSupportDisable")){const e=s.getItem("pdfViewer"),t=s.getItem("killSwitch"),o=s.getItem("cdnUrl");"false"===e&&"on"===t&&async function(e){const t=new AbortController,n=t.signal;let o=!1;setTimeout((()=>{o||t.abort()}),5e3);const a=await fetch(e,{signal:n});if(o=!0,200===a.status)return await a.text();return new Error(a.statusText)}(o).then((e=>{-1===e.toString().indexOf("<meta name='killSwitch' content='off'/>")&&-1===e.toString().indexOf('<meta name="killSwitch" content="off"/>')||(s.setItem("pdfViewer",!0),l.setViewerState("enabled"),s.setItem("killSwitch","off"),n.event(n.e.VIEWER_KILL_SWITCH_OFF_SUCCESS))})).catch((e=>{n.event(n.e.VIEWER_KILL_SWITCH_OFF_FAILED)}))}}catch(e){n.event(n.e.VIEWER_KILL_SWITCH_OFF_FAILED)}}function S(e){return t&&t.isChromeOnlyMessage(e)&&t.isEdge()&&(e+="Edge"),t&&t.getTranslation?t.getTranslation(e):chrome.i18n.getMessage(e)}function A(e){return(e.title||S("web2pdfUntitledFileName")).replace(/[<>?:|\*"\/\\'&\.]/g,"")}function R(e,t){if(!e&&!t)return!1;try{const n=e.pageUrl||t.url,o=new URL(n);if(o.protocol&&["http:","https:"].includes(o.protocol))return!0}catch(e){console.error(e)}return!1}function h(e,t){"convertPageContextMenu"===e.menuItemId?function(e,t){R(e,t)&&(n.event(n.e.CONTEXT_MENU_CONVERT_PAGE),_().handleConversionRequest({tabId:t.id,caller:p().web2pdfCaller.MENU,action:p().web2pdfAction.CONVERT,context:p().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:A(t)}))}(e,t):"appendPageContextMenu"===e.menuItemId?function(e,t){R(e,t)&&(n.event(n.e.CONTEXT_MENU_APPEND_PAGE),_().handleConversionRequest({tabId:t.id,caller:p().web2pdfCaller.MENU,action:p().web2pdfAction.APPEND,context:p().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:A(t)}))}(e,t):"convertLinkTargetToPDFContextMenu"===e.menuItemId?function(e,t){R(e,t)&&(n.event(n.e.CONTEXT_MENU_CONVERT_LINK),_().handleConversionRequest({tabId:t.id,caller:p().web2pdfCaller.MENU,action:p().web2pdfAction.CONVERT,context:p().web2pdfContext.LINK,url:e.linkUrl,domtitle:A(t)}))}(e,t):"appendLinkTargetToExistingPDFContextMenu"===e.menuItemId&&function(e,t){R(e,t)&&(n.event(n.e.CONTEXT_MENU_APPEND_LINK),_().handleConversionRequest({tabId:t.id,caller:p().web2pdfCaller.MENU,action:p().web2pdfAction.APPEND,context:p().web2pdfContext.LINK,url:e.linkUrl,domtitle:A(t)}))}(e,t)}function O(e){return t&&t.isChromeOnlyMessage(e)&&t.isEdge()&&(e+="Edge"),t&&t.getTranslation?t.getTranslation(e):chrome.i18n.getMessage(e)}function L(){const e="true"===s.getItem("pdfViewer")?"enabled":"disabled";l.setViewerState(e)}function C(e){const t=e.UsageMeasurement,n=t&&"false"===t.newValue?"false":"true";s.setItem("ANALYTICS_OPT_IN_ADMIN",n)}function v(){const e=s.getItem("pdfViewer");let t="neverTaken";"true"===e?t="enabled":"false"===e&&(t="disabled"),n.event(n.e.DEFAULT_OWNERSHIP_VIEWER_STATUS,{STATUS:t})}async function D(i){setTimeout(L,1e4),function(){try{t.isEdge()&&s.setItem("IsRunningInEdge","true")}catch(e){}}();const c=await l.isInstalledViaUpsell()?"upsell":i.installType;n.init(i.version,c),async function(){if(!s.getItem("ANALYTICS_OPT_IN_ADMIN")){const e=await chrome.storage.managed.get("UsageMeasurement"),t=e&&"false"===e.UsageMeasurement?"false":"true";s.setItem("ANALYTICS_OPT_IN_ADMIN",t)}}(),r.getItem("startupComplete")||function(){const e=s.getItem("loadedTabsInfo");if(e&&e.tabsInfo){const t=e.tabsInfo;chrome.tabs.query({},(e=>{e&&e.forEach((e=>{t.includes(e.id)&&chrome.tabs.reload(e.id)}))}))}s.removeItem("loadedTabsInfo")}(),o.getVersion((async t=>{t.ver!==a.READER_VER&&t.ver!==a.ERP_READER_VER||(a.IS_READER=!0,a.IS_ACROBAT=!1,t.ver===a.ERP_READER_VER&&(a.IS_ERP_READER=!0),t.ver===a.ERP_READER_VER?chrome.action.setTitle({title:O("web2pdfConvertButtonToolTipERPReader")}):chrome.action.setTitle({title:O("web2pdfOpenButtonText")})),function(e){0!=e&&1!=e&&e!=a.READER_VER&&e!=a.ERP_READER_VER||chrome.action.setTitle({title:""})}(t.ver),await async function(){const e=await chrome.runtime.getPlatformInfo();var t;a.OS=e.os,a.CHROME_VERSION=0,a.EXTENSION_VERSION=0;try{(t=navigator.userAgent.match(/Chrome\/([0-9]+)/))&&(a.CHROME_VERSION=+t[1])}catch(e){}try{a.EXTENSION_VERSION=chrome.runtime.getManifest().version}catch(e){}r.getItem("startupComplete")||("mac"===e.os?n.event(n.e.OS_MAC_OP):"win"===e.os&&n.event(n.e.OS_WIN_OP))}(),d({env:i,msg:t}),r.getItem("startupComplete")||(N(),function(t){const n=0==t||1==t&&!1===e.NMHConnStatus||t==a.READER_VER||t==a.ERP_READER_VER;chrome.contextMenus.removeAll((function(){a.IS_READER||n||(chrome.contextMenus.create({id:"convertPageContextMenu",title:S("web2pdfConvertPageContextMenu"),contexts:["page"],documentUrlPatterns:f}),chrome.contextMenus.create({id:"appendPageContextMenu",title:S("web2pdfAppendPageContextMenu"),contexts:["page"],documentUrlPatterns:f}),chrome.contextMenus.create({id:"convertLinkTargetToPDFContextMenu",title:S("web2pdfConvertLinkContextMenu"),contexts:["link"],documentUrlPatterns:f}),chrome.contextMenus.create({id:"appendLinkTargetToExistingPDFContextMenu",title:S("web2pdfAppendLinkContextMenu"),contexts:["link"],documentUrlPatterns:f}))}))}(t.ver),n.event(n.e.EXTENSION_STARTUP),setTimeout(v,1e4),r.setItem("startupComplete",!0))}))}function w(e){const{id:t,timestamp:o}=u,a=(new Date).getTime();e===t&&a-o<=15e3&&n.event(n.e.WELCOME_PDF_TAB_CLOSED);const r=s.getItem("signInExperimentShown");if(r){const{currTabId:t,timestamp:o}=JSON.parse(r),i=a-o,l="true"===s.getItem("signInExperimentSuppressed");e===t&&i<=15e3&&!l&&n.event(n.e.SIGN_IN_PROMPT_TAB_CLOSED),s.removeItem("signInExperimentShown"),s.removeItem("signInExperimentSuppressed")}}e.registerHandlers({themeChange:T,localeChange:e=>T({locale:e.locale})});export{D as startup,g as registerActions,w as onWelcomeTabRemoved,h as contextMenuOnClickHandler,C as updateAnalyticsOptInAdmin};