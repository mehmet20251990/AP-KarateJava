/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e}from"../common/local-storage.js";import{communicate as t}from"./communicate.js";import{privateApi as s}from"./private-api.js";import{Proxy as r}from"./proxy.js";import{util as i}from"./util.js";import{SETTINGS as a}from"./settings.js";import{EDGE_USER_STATE as o,ACROBAT_USER_STATE as n,DECLARATIVE_IMS_REFERER_HEADER as c}from"./constant.js";import{hydrateWithStorage as l}from"./hydrate.js";import{common as p}from"./common.js";let d=null;const u=a?a.POLLING_INTERVAL_IN_MINUTES:1440;class m{constructor(){this.alarmName="userSubscription",this.scopes=["AdobeID","openid","DCAPI","sign_user_read","sign_user_write","sign_user_login","sign_library_read","sign_library_write","agreement_send","agreement_read","agreement_write","ab.manage","additional_info.account_type","sao.ACOM_ESIGN_TRIAL","widget_read","widget_write","workflow_read","workflow_write"],this.proxy=r.proxy.bind(this),i.isEdge()&&this.initiateUserPolling()}initiateUserPolling(){s.isMimeHandlerAvailable().then(l((t=>{const s="true"===e.getItem("pdfViewer");t&&s?this.startUserPolling():this.stopUserPolling()})))}async getUninstallPopupSettingsFromSchema(){try{const e=await chrome.storage.managed.get("UninstallPopup");return!e||"false"!==e.UninstallPopup}catch(e){return!0}}getUserSubscription(e=[]){let t=e.find(this.checkIfPaidUser);return t||e[0]}async getUserDetails({token:t,userApiDetail:s={}}){try{const r=s.userDetailApiUrl,a={Accept:s.userSubscriptionJson,Authorization:`Bearer ${t}`,"x-api-app-info":"dc-chrome-viewer","x-request-id":i.uuid(),"x-api-client-id":`dc-chrome-viewer:${chrome.runtime.id}`,"X-Requested-With":"XMLHttpRequest"},o=await fetch(r,{method:"GET",headers:a});if(!o.ok)throw new Error(o.statusText||"API_ERROR");e.setItem("userDetailsFetchedTimeStamp",Date.now());return await o.json()}catch(e){return void console.log("Failed to fetch user detail",e)}}async updateBrowserUserState(t={}){const r=e.getItem("pdfViewer");let i="enabled";if((r&&"false"===r||!1===r)&&(i="disabled"),t&&t.level){this.checkIfUserIsFree(t)?s.setEdgeUserState({userState:o.free,viewerState:i}):s.setEdgeUserState({userState:o.subscribed,viewerState:i})}else s.setEdgeUserState({userState:o.pending,viewerState:i})}checkIfUserIsFree(e={}){return["ESign","SendNow","FillAndSign","Files"].includes(e.name)||e.level===n.free}checkIfPaidUser(e={}){return e.level!==n.free&&["DCGlobal","DCEnterprise","AcrobatPlus","AcrobatStd","PDFPack","ExportPDF","CreatePDF"].includes(e.name)}async checkIfUninstallRequired(t={}){const r=await s.isInstalledViaUpsell(),i=this.checkIfUserIsFree(t);if(r)return i;{if("admin"===e.getItem("installSource"))return!1;const t=await s.getEdgeUserState();return!(!t||t.userState!==o.subscribed||!i)}}pollUserData(e){chrome.alarms.create(this.alarmName,{delayInMinutes:e||u,periodInMinutes:u})}async getDiscoveryDetail(t){const s=p.getEnv(),r=e.getItem("dcApiUri"),i=e.getItem("envUserAPIMap")||{},a=i[s],o=a?a.discoveryExpiryTime:void 0,n=parseInt(Date.now()/1e3);if(o&&o>n)return a;try{const a={Accept:`application/vnd.adobe.dc+json; profile="${r}/schemas/discovery_v1.json"`,Authorization:`Bearer ${t}`,"x-api-app-info":"dc-chrome-viewer","x-api-client-id":`dc-chrome-viewer:${chrome.runtime.id}`},o=await fetch(`${r}/discovery`,{method:"GET",headers:a});if(!o.ok)throw new Error(o.statusText||"API_ERROR");const n=await o.json(),c=n.resources&&n.resources.users&&n.resources.users.get_user,l={userSubscriptionJson:c&&c.accept&&c.accept["user_v1.json"],discoveryExpiryTime:n.expiry,userDetailApiUrl:c&&c.resource_parameter&&c.resource_parameter.default};return c?(i[s]=l,e.setItem("envUserAPIMap",i),l):{}}catch(e){console.log("Discovery Api failed",e)}}startUserPolling(){const t=e.getItem("userDetailsFetchedTimeStamp");if(t){const e=u-Math.floor((Date.now()-t)/6e4);e<0?this.pollUserData(1):this.pollUserData(e)}else e.setItem("userDetailsFetchedTimeStamp",Date.now()),this.pollUserData()}userSubscriptionhandler(t,r,i){return s.isMimeHandlerAvailable().then((async s=>{if(s){const s={...t,main_op:""},r=!await this.getUninstallPopupSettingsFromSchema()&&"sideload"===e.getItem("installSource");s.main_op=r?"do-not-show-pop-up":"showUninstallPopUp";const{userSubscriptionData:a=[]}=t,o=this.getUserSubscription(a),n=this.checkIfUserIsFree(o||{}),c=this.checkIfPaidUser(o||{}),l=e.getItem("userEligibleForUninstall");e.setItem("userDetailsFetchedTimeStamp",Date.now()),this.pollUserData(u),n&&"true"===l?(i&&i(s),this.updateBrowserUserState(o||{})):this.checkIfUninstallRequired(o||{}).then((t=>{t?(e.setItem("userEligibleForUninstall","true"),i&&i(s)):(c&&e.removeItem("userEligibleForUninstall"),i&&i({main_op:"do-not-show-pop-up"})),this.updateBrowserUserState(o)}))}else i({main_op:"do-not-show-pop-up"})})),!0}stopUserPolling(){chrome.permissions.contains({permissions:["alarms"]},(e=>{e&&chrome.alarms.clear(this.alarmName)}))}pdfViewerValueChanged(t={}){s.isMimeHandlerAvailable().then((s=>{s&&"true"===t.value?this.startUserPolling():(e.removeItem("userDetailsFetchedTimeStamp"),this.stopUserPolling())}))}async fetchSignInToken(){try{const t=p.getEnv();await chrome.declarativeNetRequest.updateDynamicRules({addRules:[{id:c,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"referer",operation:"set",value:`chrome-extension://${chrome.runtime.id}`}]},condition:{initiatorDomains:[chrome.runtime.id],regexFilter:"ims/check/v6/token"}}],removeRuleIds:[c]});const s=e.getItem("viewerImsClientId"),r=this.scopes;let i=new FormData;const a=new Headers;a.append("client_id",s),a.append("content-type","application/x-www-form-urlencoded;charset=UTF-8"),a.append("cache-control","no-cache"),i.append("client_id",s),i.append("scope",r);const o=new URLSearchParams;o.append("client_id",s),o.append("scope",r);let n="https://adobeid-na1.services.adobe.com/ims/check/v6/token?jslVersion=v2-v0.36.0-1-g835e663";"prod"!==t&&(n="https://adobeid-na1-stg1.services.adobe.com/ims/check/v6/token?jslVersion=v2-v0.38.0-1-gdf44523");const l=await fetch(n,{method:"POST",body:o,headers:a});return await l.json()}catch(e){return console.log("Errored while fetching user details",e),{}}}async updateUserDetailInEdge(){const t=await this.fetchSignInToken(),s=t&&t.access_token?t.access_token:"";if(s){const t=await this.getDiscoveryDetail(s);if(!t)return;const r=await this.getUserDetails({token:s,userApiDetail:t});if(r?.subscriptions?.subscriptions?.length){const t=this.getUserSubscription(r.subscriptions.subscriptions),s=this.checkIfPaidUser(t);this.checkIfUninstallRequired(t).then((r=>{r?e.setItem("userEligibleForUninstall","true"):s&&e.removeItem("userEligibleForUninstall"),this.updateBrowserUserState(t)}))}}else this.updateBrowserUserState({})}}d||(d=new m);const h=d,g=e=>{e&&e.name===h.alarmName&&h.updateUserDetailInEdge()};t.registerHandlers({userSubscriptionData:d.proxy(d.userSubscriptionhandler),pdfViewerChanged:d.proxy(d.pdfViewerValueChanged)});export{h as userSubscription,g as userSubscriptionAlarmHandler};