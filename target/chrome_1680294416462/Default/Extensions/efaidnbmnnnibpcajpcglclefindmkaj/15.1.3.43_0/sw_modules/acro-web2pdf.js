/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as t}from"../common/analytics.js";import{common as e}from"./common.js";import{communicate as i}from"./communicate.js";import{util as s}from"./util.js";import{Proxy as o}from"./proxy.js";import{SETTINGS as n}from"./settings.js";var a=null,r=!1,h=2,c=13,l=[0,1,h,c,14],T=[h=2,11,12,c=13];function g(){return i.getModule("acro-gstate")}a||(a=new function(){var a=[];function E(t){var e;for(e=0;e<a.length;e+=1)if(a[e].tabId===t)return a[e];return null}function _(t){return(t=t||chrome.i18n.getMessage("web2pdfUntitledFileName")).replace(/[<>?:|\*"\/\\'&\.]/g,"")}this.proxy=o.proxy.bind(this),this.LOG=(...t)=>e.LOG(...t),this.UNSET=0,this.OPEN_IN_ACROBAT=1,this.APPEND=2,this.CONVERT_PAGE=4,this.CONVERT_LINK=8,this.CONVERT_SELECTION=16,this.PRINT=32,this.EMAIL=64,this.CALLER_TOOLBAR=128,this.CLEAN_FILE_ON_FAILURE=256,this.STATUS_WAITING=1e4,this.STATUS_DOWNLOADING=10001,this.STATUS_CONVERTING=10002,this.STATUS_SUCCESS=10003,this.STATUS_ERROR=10004,this.STATUS_NOINSTANCE=10005,this.STATUS_FILELOCKED=10006,this.STATUS_NOACROBAT=10007,this.STATUS_CANCELLED=10008,this.STATUS_FILE_OPENED=10100,this.STATUS_FILE_OPEN_FAILED=10101,this.STATUS_ERROR_JS=10110,this.STATUS_ERROR_HOST=10111,this.STATUS_ERROR_TRY=11e3,this.STATUS_ERROR_DOM=11001,this.imagePromise=null,this.errorHandler=function(){try{if(0===a.length)return;this.Done(a[0].tabId,this.STATUS_ERROR_JS,null,s.getTranslation("web2pdfHTMLJSError"))}catch(t){}},o.handlers(this.errorHandler.bind(this)),this.Done=function(t,e,i,s){if(-1===t){if(0===a.length)return;t=a[0].tabId}this.setStatus(t,e,i,s),this.nextConversion(t)},this.nextConversion=function(t){var e;for(e=0;e<a.length;e+=1)a[e].tabId===t&&a.splice(e,1);a.length>0&&a[0].start.resolve(a[0]),this.exitShim()},this.cancelConversion=function(t){var e;for(e=0;e<a.length;e+=1)a[e].tabId===t&&(a[e].start&&a[e].start.reject(),a.splice(e,1))},this.addConversion=function(t,e){return t.start=s.Deferred(),a.push(t),1===a.length?t.start.resolve(t):e&&e(),t.start},this.setStatus=function(e,o,a,r){var h,c=E(e)||this.openPDFRequest,l=new Date;s.consoleLog("setStatus: "+e+" status: "+o),c?(c.timing||(c.timing=[]),o===this.STATUS_WAITING?(h="waiting",t.event(t.e.TREFOIL_HTML_CONVERT_WAITING),c.timing.push({stage:"WAIT",start_time:l.getTime()})):o===this.STATUS_DOWNLOADING?(t.event(t.e.TREFOIL_HTML_CONVERT_DOWNLOADING),h="downloading",this.logTiming(c.timing,"WAIT")):o===this.STATUS_CONVERTING?(t.event(t.e.TREFOIL_HTML_CONVERT_IN_PROGRESS),h="in_progress",this.logTiming(c.timing,"USER_PROMPT"),c.timing.push({stage:"CONVERT",start_time:l.getTime()})):o===this.STATUS_SUCCESS?(t.event(t.e.TREFOIL_HTML_CONVERT_COMPLETE),h="complete",this.logTiming(c.timing,"CONVERT")):o===this.STATUS_ERROR?(t.event(t.e.TREFOIL_HTML_CONVERT_FAILED),h="failure"):o===this.STATUS_ERROR_JS?(t.event(t.e.TREFOIL_HTML_CONVERT_FAILED_JS),h="failure"):o===this.STATUS_ERROR_TRY?(t.event(t.e.TREFOIL_HTML_CONVERT_FAILED_TRY),h="failure"):o===this.STATUS_ERROR_DOM?(t.event(t.e.TREFOIL_HTML_CONVERT_FAILED_DOM),h="failure"):o===this.STATUS_ERROR_HOST?(t.event(t.e.TREFOIL_HTML_CONVERT_FAILED_HOST),h="failure"):o===this.STATUS_CANCELLED?(t.event(t.e.TREFOIL_HTML_CONVERT_CANCELLED),h="cancelled",this.logTiming(c.timing,"USER_PROMPT")):o===this.STATUS_NOACROBAT?(t.event(t.e.TREFOIL_HTML_CONVERT_NO_ACROBAT),h="noacrobat"):o===this.STATUS_FILELOCKED?h="filelocked":o===this.STATUS_FILE_OPENED?("pdfviewer"!==c.click_context&&(c.version===n.READER_VER?c.newUI?t.event(t.e.PERSIST_PDF_DOWNLOAD_OPENED_READER):t.event(t.e.TREFOIL_PDF_DOWNLOAD_OPENED_READER):c.newUI?t.event(t.e.PERSIST_PDF_DOWNLOAD_OPENED):t.event(t.e.TREFOIL_PDF_DOWNLOAD_OPENED)),h="pdf_opened"):o===this.STATUS_FILE_OPEN_FAILED?("pdfviewer"!==c.click_context&&(c.version===n.READER_VER?t.event(t.e.TREFOIL_PDF_DOWNLOAD_OPEN_FAILED_READER):t.event(t.e.TREFOIL_PDF_DOWNLOAD_OPEN_FAILED)),h="pdf_open_failed"):(s.consoleLog("Unexpected status: "+o),h="unknown"),c.panel_op="status",c.current_status=h,a&&(c.file_path=a),r&&(c.message=r),"pdfviewer"!==c.click_context&&i.deferMessage(c)):s.consoleLog("failed to find conversion for tabId: "+e)},this.setNcPort=function(t){this.ncPort=t},this.nativeMessageCallback=function(t){var e,i;"setStateCallback"===t.messageType?this.setStatus(+t.conversionID,+t.state):"doneCallback"===t.messageType?(t.filePath&&(e=s.atob16(t.filePath)),this.Done(+t.conversionID,+t.state,e)):"getMessageCallback"===t.messageType?this.sendMessageToNative({message:(i=t.msgIDStr,s&&s.isChromeOnlyMessage(i)&&s.isEdge()&&(i+="Edge"),chrome.i18n.getMessage(i)||chrome.i18n.getMessage("web2pdfStatusError"))}):"saveSuccessCallback"===t.messageType?(e=s.atob16(t.path),this.imagePromise.resolve(e)):"saveFailureCallback"===t.messageType?(s.consoleLogDir("failed to save image"),this.imagePromise.reject()):"shimVersionInfo"===t.messageType?this.versionCallback&&(this.versionCallback(t),delete this.versionCallback):"fileOpenCallback"===t.messageType&&(0==+t.state?this.setStatus(0,this.STATUS_FILE_OPENED):this.setStatus(0,this.STATUS_FILE_OPEN_FAILED),this.openPDFRequest&&(this.nextConversion(this.openPDFRequest.tabId),delete this.openPDFRequest))},this.nativeOnDisconnect=function(){var t=this.STATUS_ERROR;"Specified native messaging host not found."===chrome.runtime.lastError.message&&(this.versionCallback&&(this.versionCallback({messageType:"shimVersionInfo",majorVersion:"0",minorVersion:"0"}),delete this.versionCallback),t=this.STATUS_NOACROBAT),"Native host has exited"===chrome.runtime.lastError.message&&(t=this.STATUS_ERROR_HOST),this.ncPort=null,this.Done(-1,t)},this.init=function(){this.ncPort=chrome.runtime.connectNative("com.adobe.acrobat.chrome_webcapture"),this.ncPort.onMessage.addListener(this.proxy(this.nativeMessageCallback)),this.ncPort.onDisconnect.addListener(this.proxy(this.nativeOnDisconnect))},this.sendMessageToNative=function(t){i.legacyShim()&&t.task&&-1===l.indexOf(t.task)?s.consoleLog("Skipping task: "+t.task+" in legacy shim"):(this.ncPort||this.init(),t.browser=s.getBrowser(),this.ncPort.postMessage(t),-1!==T.indexOf(t.task)&&setTimeout(this.proxy((function(){this.exitShim()})),1e3))},this.exitShim=function(){0===a.length&&this.sendMessageToNative({task:14})},this.getVersion=function(t){this.versionCallback=t,this.sendMessageToNative({task:c})},this.openInAcrobat=function(e){e.newUI&&i.resetPersistPrefCount(),this.addConversion(e).then(this.proxy((function(e){this.openPDFRequest=e;const i=s.removeQueryParams(e.url);!0===e.isSharePointURL?this.sendMessageToNative({task:16,url:i}):(this.sendMessageToNative({task:12,pdfData:e.base64PDF.split(",")[1],fileName:e.filename,paramName:e.paramName}),t.checkAndLogPDFSize(e.base64PDF.length/1048576),delete e.base64PDF)})))},this.openFile=function(t){0===a.length&&this.sendMessageToNative({task:11,filePath:t.file_path})},this.SendForConversion=function(t,e){try{var i,s=new Date;i=0!=(t.conversionSettings&this.APPEND)?1:0,e.timing||(e.timing=[]),e.timing.push({stage:"USER_PROMPT",start_time:s.getTime()}),e.outputPath?0===e.action?this.sendMessageToNative({task:3,conversionID:e.tabId,domData:t.domData,conversionSettings:t.conversionSettings,charset:t.charset,url:t.url,docTitle:t.domtitle,outputPath:e.outputPath}):1===e.action&&this.sendMessageToNative({task:4,conversionID:e.tabId,domData:t.domData,conversionSettings:t.conversionSettings,charset:t.charset,url:t.url,docTitle:t.domtitle,outputPath:e.outputPath}):this.sendMessageToNative({task:i,conversionID:e.tabId,domData:t.domData,conversionSettings:t.conversionSettings,charset:t.charset,url:t.url,docTitle:t.domtitle})}catch(t){this.Done(e.tabId,this.STATUS_ERROR_TRY)}},this.showConversionSettingsDialog=function(){0===a.length&&this.sendMessageToNative({task:h})},this.convertToPDF=function(t,e){t.conversionSettings=this.UNSET,g().getViewResultsPreferenceState()&&(t.conversionSettings|=this.OPEN_IN_ACROBAT),t.action===g().web2pdfAction.APPEND?t.conversionSettings|=this.APPEND:t.conversionSettings|=this.CLEAN_FILE_ON_FAILURE,t.context===g().web2pdfContext.PAGE&&(t.conversionSettings|=this.CONVERT_PAGE),t.caller===g().web2pdfCaller.TOOLBAR?t.conversionSettings|=this.CALLER_TOOLBAR:t.context===g().web2pdfContext.LINK&&(t.conversionSettings|=this.CONVERT_LINK),this.SendForConversion(t,e)},this.processImages=function(t,e,i){var o=t.blob.refs[e],n=new Date;return t.timing||(t.timing=[]),t.imagesComplete||(t.imagesComplete=s.Deferred()),this.imagePromise=s.Deferred(),e>=t.blob.refs.length?(this.imagePromise.resolve(),t.imagesComplete.resolve(),this.imagePromise):(o.data&&"data:"!==o.data?"image"===o.type?(r||(t.timing.push({stage:"SEND_IMAGES",start_time:n.getTime()}),r=!0),t.blob.refs.splice(e,1),this.sendMessageToNative({task:10,imagedata:o.data.split(",")[1],conversionID:t.tabId}),this.imagePromise.then(this.proxy((function(t){i.push("<AcroexchangeDownloadSeprator AcroexchangeDownloadUrl="+o.placeholder+"><FILEPATH>"+t+"</FILEPATH></AcroexchangeDownloadSeprator>")})),(function(){}))):(this.imagePromise.resolve(),e+=1):(t.blob.refs.splice(e,1),this.imagePromise.resolve()),this.imagePromise.done(this.proxy((function(){this.processImages(t,e,i)}))),this.imagePromise)},this.acro_html=function(e,i){var o,n,a;e.error?(s.consoleError(e.error),t.logError(e.error_analytics),this.Done(e.tabId,this.STATUS_ERROR_DOM,null,s.getTranslation(e.error))):(t.checkAndLogHTMLBlobSize(e.blob.currentSize/1048576),t.logContents(e),e.analytics&&t.setParamsAndLogAnalytics(e.analytics,t.e.HTML_SOURCE_CONTENT,"content"),t.setArg("stage","CLONE"),t.checkAndLogTimingRange(e.cloneTiming),(a=E(e.tabId)).blob=e.blob,n=[],r=!1,this.processImages(a,0,n),a.imagesComplete.then(this.proxy((function(){for(delete a.imagesComplete,this.logTiming(a.timing,"SEND_IMAGES"),n.push("<AcroexchangeDownloadSeprator AcroexchangeDownloadUrl="+i.tab.url+">"+a.blob.html+"</AcroexchangeDownloadSeprator>"),o=0;o<a.blob.refs.length;o+=1)n.push("<AcroexchangeDownloadSeprator AcroexchangeDownloadUrl="+a.blob.refs[o].placeholder+">"+a.blob.refs[o].data+"</AcroexchangeDownloadSeprator>");delete a.blob,this.convertToPDF({caller:a.caller,action:a.action,context:g().web2pdfContext.PAGE,domData:n.join("\n"),charset:"UTF-8",domtitle:a.domtitle,url:a.url},a)}))))},this.logTiming=function(e,i){var s,o=new Date;e.forEach((function(e){e.stage===i&&(s=o.getTime()-e.start_time,t.setArg("stage",i),t.checkAndLogTimingRange(s/100))}))},this.handleConversionRequest=function(e){if(n.IS_ACROBAT){var s=this.proxy((function(){this.setStatus(e.tabId,this.STATUS_WAITING)}));i.legacyShim()||e.context!==g().web2pdfContext.PAGE?(i.legacyShim()||e.context===g().web2pdfContext.LINK)&&this.addConversion(e,s).then(this.proxy((function(t){this.convertToPDF({caller:t.caller,action:t.action,context:t.context,domData:"",charset:"UTF-8",domtitle:t.domtitle,url:t.url},t)}))):this.addConversion(e,s).then(this.proxy((function(e){delete e.start,this.setStatus(e.tabId,this.STATUS_DOWNLOADING),t.logSiteAndProtocolAnalytics(e.url),chrome.scripting.executeScript({target:{tabId:e.tabId},injectImmediately:!0,func:(t,e,i)=>{window.maxSize=e,window.DEBUG=i,window.TABID=t,window.OP="acro-html",window.EXCLUDE=["font","svg_image"]},args:[e.tabId,n.MAX_HTML_SIZE,n.DEBUG_MODE]},this.proxy((function(){if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);chrome.scripting.executeScript({target:{tabId:e.tabId},files:["content_scripts/get-html.js"]})})))})))}},this.convertToPDFPopupMenu=function(t,e){var i={tabId:e.tab.id,caller:g().web2pdfCaller.TOOLBAR,action:g().web2pdfAction.CONVERT,context:g().web2pdfContext.PAGE,url:e.tab.url,domtitle:_(e.tab.title)};t.outputPath&&(i.outputPath=t.outputPath),this.handleConversionRequest(i)},this.appendToExistingPDFPopupMenu=function(t,e){var i={tabId:e.tab.id,caller:g().web2pdfCaller.TOOLBAR,action:g().web2pdfAction.APPEND,context:g().web2pdfContext.PAGE,url:e.tab.url,domtitle:_(e.tab.title)};t.outputPath&&(i.outputPath=t.outputPath),this.handleConversionRequest(i)}},i.registerModule("acro-web2pdf",a),n.IS_ACROBAT&&i.registerHandlers({"acro-html":a.proxy(a.acro_html),appendToExistingPDFPopupMenu:a.proxy(a.appendToExistingPDFPopupMenu),convertToPDFPopupMenu:a.proxy(a.convertToPDFPopupMenu),showConversionSettingsDialog:a.proxy(a.showConversionSettingsDialog)}));export const acroweb2pdf=a;